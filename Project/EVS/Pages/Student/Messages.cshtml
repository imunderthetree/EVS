@page
@using System.Data
@model EVS.Pages.Student.MessagesModel
@{
    ViewData["Title"] = "Messages";
}
@section Sidebar {
    @await Html.PartialAsync("_StudentSidebar")
}

<style>
    .messages-container {
        display: flex;
        gap: 20px;
        padding: 18px;
        font-family: Arial, sans-serif;
    }

    .conversations {
        width: 320px;
        min-width: 260px;
        background: #fff;
        border: 1px solid #e2e2e2;
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 720px;
    }

        .conversations .header {
            padding: 12px 14px;
            border-bottom: 1px solid #f0f0f0;
            font-weight: 600;
        }

        .conversations .search {
            padding: 10px 14px;
            border-bottom: 1px solid #f0f0f0;
        }

        .conversations .list {
            overflow-y: auto;
            padding: 6px 0;
            flex: 1;
        }

    .conv-item {
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 10px 14px;
        cursor: pointer;
        border-bottom: 1px solid #f7f7f7;
        text-decoration: none;
        color: inherit;
    }
        
        .conv-item:hover {
            background: #fafafa;
        }

        .conv-item.active {
            background: #e7f4ff;
        }

        .conv-item .avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #ddd;
            flex: 0 0 44px;
            overflow: hidden;
        }

            .conv-item .avatar img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .conv-item .meta {
            flex: 1;
            min-width: 0;
        }

        .conv-item .name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conv-item .preview {
            font-size: 13px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conv-item .time {
            font-size: 12px;
            color: #999;
            flex-shrink: 0;
        }

    .chat-pane {
        flex: 1;
        background: #fff;
        border: 1px solid #e2e2e2;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        height: 720px;
        overflow: hidden;
    }

    .chat-header {
        padding: 12px 16px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        gap: 12px;
    }

        .chat-header .avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: #ddd;
            overflow: hidden;
            flex: 0 0 52px;
        }

            .chat-header .avatar img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

    .chat-messages {
        padding: 16px;
        overflow-y: auto;
        flex: 1;
        background: #fafbfd;
        display: flex;
        flex-direction: column;
    }

    .message {
        max-width: 72%;
        padding: 10px 12px;
        border-radius: 12px;
        margin-bottom: 12px;
        font-size: 14px;
        line-height: 1.4;
    }

        .message.in {
            background: #e7f4ff;
            align-self: flex-start;
        }

        .message.out {
            background: #e9f7ea;
            align-self: flex-end;
        }

        .message .meta {
            font-size: 12px;
            color: #666;
            margin-top: 6px;
        }

    .composer {
        padding: 12px;
        border-top: 1px solid #f0f0f0;
        display: flex;
        gap: 10px;
        align-items: center;
    }

        .composer textarea.form-control {
            resize: none;
            height: 64px;
        }

    @Html.Raw(@"@media (max-width: 980px) {
        .messages-container {
            flex-direction: column;
            padding: 12px;
        }

        .conversations {
            width: 100%;
            height: 320px;
        }

        .chat-pane {
            height: 520px;
        }
    }")
</style>

<div class="container-fluid">
    <h2 class="mb-4">Messages</h2>
    <div class="messages-container" role="region" aria-label="Student messaging interface">
        <!-- Conversations list -->
        <aside class="conversations" aria-label="Conversations">
            <div class="header">Conversations</div>
            <div class="search">
                <input class="form-control" type="search" placeholder="Search teachers or messages" aria-label="Search conversations" />
            </div>
            <div class="list" role="list">
                @if (Model.Threads.Count > 0)
                {
                    @foreach (var thread in Model.Threads)
                    {
                        var isActive = Model.SelectedThreadId == thread.Id;
                        var lastMessage = thread.Messages.OrderByDescending(m => m.SentAt).FirstOrDefault();
                        var otherUserId = int.Parse(thread.Id);
                        var otherUserName = Model.GetUserName(otherUserId);
                        <a class="conv-item @(isActive ? "active" : "")" role="listitem"
                           asp-page="./Messages" asp-route-SelectedThreadId="@thread.Id">
                            <div class="avatar">
                                <img src="https://bootdey.com/img/Content/avatar/avatar1.png" alt="@otherUserName" />
                            </div>
                            <div class="meta">
                                <div class="name">@otherUserName</div>
                                <div class="preview">@(lastMessage?.Content ?? "No messages")</div>
                            </div>
                            <div class="time">@thread.LastUpdated.ToString("MMM dd")</div>
                        </a>
                    }
                }
                else
                {
                    <div class="p-3 text-muted">No conversations yet.</div>
                }
            </div>
        </aside>

        <!-- Chat area -->
        <section class="chat-pane" aria-label="Active conversation">
            @{
                var selectedThread = Model.Threads.FirstOrDefault(t => t.Id == Model.SelectedThreadId);
                var selectedUserName = selectedThread != null ? Model.GetUserName(int.Parse(selectedThread.Id)) : "";
            }
            @if (selectedThread != null)
            {
                <div class="chat-header">
                    <div class="avatar">
                        <img src="https://bootdey.com/img/Content/avatar/avatar1.png" alt="@selectedUserName" />
                    </div>
                    <div>
                        <div style="font-weight:600;">@selectedUserName</div>
                        <div style="font-size:13px;color:#666;">@selectedThread.Messages.Count message(s)</div>
                    </div>
                </div>
                <div class="chat-messages" aria-live="polite">
                    @foreach (var msg in selectedThread.Messages.OrderBy(m => m.SentAt))
                    {
                        var isOut = msg.SenderId == Model.StudentId.ToString();
                        var senderName = isOut ? "You" : Model.GetUserName(int.Parse(msg.SenderId));
                        <div class="message @(isOut ? "out" : "in")" role="article">
                            <div>@msg.Content</div>
                            <div class="meta">@senderName • @msg.SentAt.ToString("MMM dd, hh:mm tt")</div>
                        </div>
                    }
                </div>
                <form method="post" asp-page-handler="Send" class="composer">
                    <input type="hidden" asp-for="ReceiverId" value="@selectedThread.Id" />
                    <textarea asp-for="MessageContent" class="form-control" placeholder="Type your reply..." required></textarea>
                    <button class="btn btn-primary" type="submit" title="Send">
                        <i class="fa fa-paper-plane" aria-hidden="true"></i> Send
                    </button>
                </form>
            }
            else
            {
                <div class="chat-header">
                    <div class="avatar">
                        <img src="https://bootdey.com/img/Content/avatar/avatar2.png" alt="User" />
                    </div>
                    <div>
                        <div style="font-weight:600;">No conversation selected</div>
                        <div style="font-size:13px;color:#666;">Select a conversation to view messages.</div>
                    </div>
                </div>
                <div class="chat-messages">
                    <div class="p-3 text-muted">Select a conversation from the list to view messages.</div>
                </div>
            }
        </section>
    </div>
</div>